---
title: "Data Science Project -  A Review of the Relationship Between Personal Factors and Measured Blood Pressure"
author: "Memes and Music: \nRich Gude \nSiwei Yang \nJunhe Zhang \nKrystal Payton"
date: "March 11, 2020"
output:
  html_document:
  code_folding: hide
number_sections: true
toc: yes
toc_depth: 2
toc_float: yes
pdf_document:
  toc: yes
---
  
```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
knitr::opts_chunk$set(warning = F, results = T, message = F)
# knitr::opts_chunk$set(warning = F, results = F, message = F)
# knitr::opts_chunk$set(include = F)
# knitr::opts_chunk$set(echo = TRUE)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# 'scipen': integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than 'scipen' digits wider.
# use scipen=999 to prevent scientific notation at all times
```

```{r basicfcn, include=F}
# use this function to conveniently load libraries and work smoothly with knitting
# can add quietly=T option to the require() function
# note that using this function requires quotes around the package name, as you would when installing packages.
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
# unload/detact package when done using it
# detach_package = function(pkg, character.only = FALSE) { if(!character.only) { pkg <- deparse(substitute(pkg)) } search_item <- paste("package", pkg, sep = ":") while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } }
```

```{r outlierKD2, include = F}
# Fix outliers
outlierKD2 <- function(df, var, rm=FALSE) { 
    #' Original outlierKD functino by By Klodian Dhana,
    #' https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
    #' Modified to have third argument for removing outliers instead of interactive prompt, 
    #' and after removing outlier, original df will not be changed. The function returns the new df, 
    #' which can be saved as original df name if desired.
    #' Check outliers, and option to remove them, save as a new dataframe. 
    #' @param df The dataframe.
    #' @param var The variable in the dataframe to be checked for outliers
    #' @param rm Boolean. Whether to remove outliers or not.
    #' @return The dataframe with outliers replaced by NA if rm==TRUE, or df if nothing changed
    #' @examples
    #' outlierKD2(mydf, height, FALSE)
    #' mydf = outlierKD2(mydf, height, TRUE)
    #' mydfnew = outlierKD2(mydf, height, TRUE)
    dt = df # duplicate the dataframe for potential alteration
    var_name <- eval(substitute(var),eval(dt))
    na1 <- sum(is.na(var_name))
    m1 <- mean(var_name, na.rm = T)
    par(mfrow=c(2, 2), oma=c(0,0,3,0))
    boxplot(var_name, main="With outliers")
    hist(var_name, main="With outliers", xlab=NA, ylab=NA)
    outlier <- boxplot.stats(var_name)$out
    mo <- mean(outlier)
    var_name <- ifelse(var_name %in% outlier, NA, var_name)
    boxplot(var_name, main="Without outliers")
    hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
    title("Outlier Check", outer=TRUE)
    na2 <- sum(is.na(var_name))
    cat("Outliers identified:", na2 - na1, "\n")
    cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "\n")
    cat("Mean of the outliers:", round(mo, 2), "\n")
    m2 <- mean(var_name, na.rm = T)
    cat("Mean without removing outliers:", round(m1, 2), "\n")
    cat("Mean if we remove outliers:", round(m2, 2), "\n")
    
    # response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ")
    # if(response == "y" | response == "yes"){
    if(rm){
        dt[as.character(substitute(var))] <- invisible(var_name)
        #assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
        cat("Outliers successfully removed", "\n")
        return(invisible(dt))
    } else {
        cat("Nothing changed", "\n")
        return(invisible(df))
    }
}

```

# Executive Summary:


# Purpose:

To analyze examination and survey data from the National Center of Health Statistics taken from the National Health and Nutrition Examination Surveys from 10,000 interviewees from 2005 and 2006 and identify any link or lackthereof between measured blood pressure data and the ethnicity, gender, age, household income, or veteran status of adult (ages 18 and older) individuals.

# Data Background:

The National Center for Health Statistics (NCHS) conducts an annual series of personal interviews and examinations of 5000 Americans from 15 counties across the United States for the purpose of assessing health and nutrional status of adults and children in the United States.  This series of interviews is known as the National Health and Nutrition Examination Surveys (NHANES).

For the NHANES from 2005 and 2006, conducted from January 2015 though December 2006, 10,348 **[NEED TO CONFIRM FROM DATA]** indiviudals were interviewed and/or examined.  The data collected within these surveys is solely for the purpose of statistical analysis and reporting; direct identifiers and characteristics that might lead to identification of data subjects have been removed prior to distribution.

# Study Design

The NCHS conducts in-home interviews of roughly 7,000 individuals of all ages each year.  Of these 7,000, roughly 5,000 complete health examination surveys.  The target population for interviewees is the non-institualized, civilian United States population.  The 2005 and 2006 NHANES include an over-samping of teenage adoloescents (ages 12 to 19), elderly individuals (ages 60 or greater), African Americans, and Mexican Americans. Ethnic, gender, age, houshold income, and veteran status data are solicited during the interview portion while blood pressure readings are taken during the examination portion of the NHANES.

Interviews are predominantly conducted in-person at the interviewee's domicile and are composed of screener, sample person, and family interviews.  Interviewees are mailed information regarding the study prior to interveiwer arrival at the domicile and, at the time of the interview, are provided and asked to sign consent forms agreeing to particiapte in the interviews and medical examinations.  Blood pressure reading are generally taken at mobile examination centers or, if the participant is unable to make it to the center, within their homes.

# A Discussion of the Data

As stated in the purpose, this study will investigate the relationship, or lack thereof, between the blood pressure and the ethnicity, gender, age, houshold income, or veteran status of an individual.  The blood pressure of an individual is a based on a complex series of interactions between many factors including genetics, personal exercise and diet, and access to advanced healthcare.  From the NHANES studies, at least some of these factors can be quantified and, accordingly, allow for appropriately quantitative and qualitative testing to identify a prospective magnitude to which these factors may affect blood pressure: ethnicity, gender, and age provide qualitative measures for genetic factors on blood pressure, veteran status provides a qualitative measure for personal exercise [THIS MAY BE A BIG ASSUMPTION AND WE MAY WANT TO DISCUSS FURTHER], and household income provides a quantitative measure for access to advanced healthcare.

The population from which this data is derived is that of 10,000 American individuals from 30 different United States counties.  For that reason, the conclusions of this study should only be applied to American individuals as there may be some bias within the data with respect to the American health system and general culture.  For instance:

- If household income or veteran status can be considered metrics of access to advanced healthcare, any trend in these two variables with respect to blood pressure may be diminished or exacerbated in comparison to individuals from countries with established publicly-funded healthcare systems (e.g., low-income households may have more access to advanced healthcare in publicly-funded healthcare systems versus those households in the American privately-funded healthcare system).
- There may be general genetic differences in enthnicities in American populations versus similar ethnic populations in other countries, so any trends between the enthincities discussed within this report may not be representatives of said ethnicities outside of the United States.

In addition, as there is limited discussion in the data report regarding where the 30 counties are located within the United States in order to ensure confidentiality of participants, there may be some regional bias within the United States from the data; however, this is difficult to quantify without additional information.

# Data Preprocessing

As part of the survey and examination, the 2005 and 2006 NHANES solicited over 69 variables from the participants (not counting an unique identification number for each participant), including pulse, four reading of the diastolic and systolic pressures each, education level, marital status, and many others.  For the purposes of this study, only 18 variables are of particular interest; they are as such:

#### Participant Variables of Interest

**1. Participant Sequence Number **

**2 - 5. Did Participant have food/alcohol/coffee/cigarettes in the 30 minutes prior to the Examination? **

**6 - 9. Four Individual Measures of the Participant Diastolic Blood Pressure (in mmHg)**

**10 - 13. Four Individual Measures of the Participant Systolic Blood Pressure (in mmHg)**

**14. Participant Ethnicity, documented as: Mexican American, Other Hispanic, Non-Hispanic White, Non-Hispanic Black, or Other Race**

**15. Participant Gender, documented as: Male or Female**

**16. Participant Age, documented as: 18 - 85 - particpants 85 and older are topcoded at 85**

**17. Participant Veteran Status, documented as "Did Participant ever serve in the Armed Forces of the United States?": Yes or No**

**18. Annual Household Income of Participant, documented as ranges of US dollars as such: $0 to $9999, $10000 to $19999, $20000 to $34999, $35000 to $54999, $55000 to $74999, or over $75000** [WE WILL IGNORE THE OTHER CATEGORIES FOR ALL VARIABLES THAT ARE NOT LISTED HERE SUCH AS UNDER $20000 FOR HOUSEHOLD INCOME]

In preprocessing the data, all of the column variables not listed above from the NHANES data were eliminated from the study dataset in addition to all rows of data that had infant or adolescent data (participant age less than 18 years of age).  Following that, participants that had consumed a stimulant or depressant, such as food, caffeine, nicotine, or alcohol, within the 30 minutes prior to the blood pressure examination, corresponding to particpant variables 6 through 9 above, were eliminated from the dataset so as to not adversely affect the factors under consideration during this study (participants with missing information for these variables are assumed to have taken a stimulant/depressant and will be included in the study).

During the examination, four measures of both the systolic and diastolic pressures were taken for each participant.  In some cases, less than four measurements were taken.  In order to standardize the measured systolic and diastolic pressure measurements, two new columns for the average systolic and diastolic pressures across all of the measurements with relevant measurements, "SystolAvg" and "DiastolAvg", respectively, were created.  All participants with missing data or measured blood pressures of nill (0) for either pressure (clearly indicating an erroronous measurement) were dropped from this study's consideration.

**[I AM STILL NOT SURE IF THE RIGHT CALL IS TO REMOVE ALL ROWS THAT HAVE MISSING OR INCONEVNIENT DATA IN ANY VARIABLE COLUMN OR HAVE THE 5 SEPARATE DATA SUBSETS...  WE MAY NEED TO DISCUSS WITH THE PROFESSOR]**

```{r loadData, include=F}
# This is the chunk of programming that takes the Blood Pressure DTA file and converts it into a dataframe.
loadPkg('tidyverse')
loadPkg('foreign')      # Necessary to import DTA files
loadPkg('agricolae')    # Necessary for Scheffe Test

dataBP <- read.dta('SampleData_BP.dta')
```

```{r preprocess, include=T}
# This code package preprocesses out all of the columns that are not necessary from the Blood Pressure data as well as all of the rows for participants that do not satisfy the "adult" criteria (anyone with an age < 17 years)

# First subset is to narrow rows by age and select relevant columns 
dataSubset <- subset(dataBP, RIDAGEYR > 17, select = c('SEQN', 'BPQ150A', 'BPQ150B', 'BPQ150C', 'BPQ150D', 'BPXSY1', 'BPXSY2', 'BPXSY3', 'BPXSY4', 'BPXDI1', 'BPXDI2', 'BPXDI3', 'BPXDI4', 'RIAGENDR', 'RIDAGEYR', 'RIDRETH1', 'DMQMILIT', 'INDHHINC'))

# The function below shows that all columns are either factors or intergers and all are appropriate to the data
# sapply(dataSubset, class)

# Second Subset is to remove all rows with 'Yes' responses from stimulant/depressant columns (missing columns are treated as 'Yes')

dataSubset <- subset(dataSubset, BPQ150A != 'Yes' &  BPQ150B != 'Yes' & BPQ150C != 'Yes' & BPQ150D != 'Yes')

# Using the summary function, we see that there are many missing values in the systolic and diastolic pressure columns (some have only one or two readings vice 4 like others).  There are tests we could have done if we had four sample pressures for every applicant (such as testing if all of the pressures were the same, but instead we're going to just average all of the columns that have any measurements and use those two averages for all further evaluations.
# Create two new columns that average the values from all of the pressure readings for systolic and diastolic pressures (NAs are not evaluated)

dataSubset$SystolAvg <- rowMeans(dataSubset[c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')], na.rm=TRUE)
dataSubset$DiastolAvg <- rowMeans(dataSubset[c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')], na.rm=TRUE)

# Drop all rows that are 0 or NA in the Average Systolic and Diastolic columns (these are clearly inappropriately marked or missing data that we cannot use), and then drop all rows that we don't need (the original stimulant/depressant marker questions and the four readings for systolic and diastolic pressures).  The column dropping is for general tidiness.

dataSubset <- subset(dataSubset, SystolAvg != 0 &  DiastolAvg != 0, select = c('SEQN', 'SystolAvg', 'DiastolAvg', 'RIAGENDR', 'RIDAGEYR', 'RIDRETH1', 'DMQMILIT', 'INDHHINC'))
summary(dataSubset)

```

```{r ageGroup}
# create ageGroup feature/variable
dataSubset$ageGroup = 
  ifelse( (dataSubset$RIDAGEYR>=18)&(dataSubset$RIDAGEYR<30) , 
          "young" , 
          ifelse( 
            (dataSubset$RIDAGEYR>=30)&(dataSubset$RIDAGEYR<50), 
            "middle", 
            ifelse(
              dataSubset$RIDAGEYR>=50,
              "elder",
              "unknown"
            )
          )
        )
```

# Variable Anaylsis and Approach

The purpose of this study is to identify any link or lackthereof between the blood pressure and one of five factors, ethnicity, age, veteran status, gender, and annual household income, based on the survey and examination data from random group of American individuals.  Each variable and their associated effect will be examined in the following five sections.  Each section will review the distribution of the data within each subcategory of the variable (e.g., male versus female in gender or the five surveyed ethnicities in ethnicity).  In order to determine whether blood pressure is dependent or independent of each variable, an Anaylsis of Variance (ANOVA) test for variables with more than two categories or a T-Test for bi-modal variables, such as gender, will be used to identify if there is any difference in the average blood pressure value between the categories.  If there is no statistical difference in the average blood pressure values across the categories of a variable, that variable will be considered to not affect blood pressure.

Additional analysis of the governing assumptions for the ANOVA or T-Tests will be presented in each section as appropriate based on the distribution of the data amongst each categorical group.

# The Effect of Ethnicity on Blood Pressure (presented by Rich Gude)

For the sake of this study, the ethnicity of the participant is a qualitative, categorical variable.  Participants were asked to provide one of five ethnicities, and the 2005 and 2006 NHANES included an oversampling of Mexican and African Americans.  The results of the ethnic information provided by participants in the 2005 and 2006 NHANES studies are provided in the bar graph below:

``` {r, EthnicBarGraph, include=T}

# Create a dummy table to plug into the barplot function.  Define all axises titles and the color palette (coded to ethnicity)
ethnic_Count <- table(dataSubset$RIDRETH1)
barPlot_Ethnicity <- barplot(ethnic_Count,
                             main="Self-Identified Participant Ethnicity",
                             xlab="Participant Ethnicity",
                             ylab='Count of Participants',
                             names.arg= c('Mex Amer', 'NonMex Hisp', 'Caucasian', 'Afr Amer', 'Other'),
                             col= c('tan', 'red', 'white', 'black', 'blue'))

```

This study will use the ethnic and blood pressure data from `r sum(ethnic_Count)` total participants who passed the data preprocessing steps described above (i.e., those that are of age and contained adequeate blood pressure data).  Of those:
`r sum(ethnic_Count["Mexican American"])` or `r sum(ethnic_Count["Mexican American"])/sum(ethnic_Count)*100`% were Mexican American,
`r sum(ethnic_Count["Other Hispanic"])` or `r sum(ethnic_Count["Other Hispanic"])/sum(ethnic_Count)*100`% were Non-Mexican Hispanic American,
`r sum(ethnic_Count["Non-Hispanic White"])` or `r sum(ethnic_Count["Non-Hispanic White"])/sum(ethnic_Count)*100`% were Caucasian American,
`r sum(ethnic_Count["Non-Hispanic Black"])` or `r sum(ethnic_Count["Non-Hispanic Black"])/sum(ethnic_Count)*100`% were African American, and
`r sum(ethnic_Count["Other Race - Including Multi-Racial"])` or `r sum(ethnic_Count["Other Race - Including Multi-Racial"])/sum(ethnic_Count)*100`% were another ethnicity or multiethnic.

## Discussion of the Normality and other Assumptions of the ANOVA Test for Blood Pressure Data between Ethnic Groups

The Analysis of Variance (ANOVA) Test can be used to identify whether all of the ethnic groups accounted within the dataset have the same systolic blood pressures; however, the ANOVA test assumes three facets of the data:
1. The data for each group is normally distributed.
2. The variance in the data within each group is equivalent to other groups
3. The error within the data is independent of the magnitude of the value

The following tests were performed in order to verify the assumptions of the ANOVA test: The Shapiro-Wilk Test will be used to determine the whether the data is normally distributed amongst each ethnicity and blood pressure type, the Bartlett test of homogeneity of variances will be used to test whether the variance within each group is equivalent, and a plot of the residuals from the ANOVA test object will identify the extent of the error within the data and whether it changes with blood pressure values.  For the Shapiro-Wilk test, the null hypothesis is the data is normally distributed with respect to the blood pressure; for a Shapiro-Wilk probability value less than 0.05 (based on a 95% confidence interval), the data will not be considered normally-distributed between for the given ethnic group and blood pressure type.  For the Bartlett test, the null hypothesis is the variance in data between the groups is equivalent; for a Bartlett probability less than 0.05 (based on a 95% confidence interval), the variance will not be considered equivalent between all five ethnic groups.

The histogram plot of the average systolic and diastolic blood pressures from each ethnic group are presented below:

``` {r, EthnicHistograms, include=T}

# Develop a dummy dataframe for Mexican American histograms
dumMexican <- subset(dataSubset, RIDRETH1 == 'Mexican American')
hist_MexSyst <- hist(dumMexican$SystolAvg,
                     main="Histogram of Mexican American Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='tan')
hist_MexDias <- hist(dumMexican$DiastolAvg,
                     main="Histogram of Mexican American Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='tan')

# Develop a dummy dataframe for Hispanic American histograms
dumHispanic <- subset(dataSubset, RIDRETH1 == 'Other Hispanic')
hist_HisSyst <- hist(dumHispanic$SystolAvg,
                     main="Histogram of Hispanic American Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='red')
hist_HisDias <- hist(dumHispanic$DiastolAvg,
                     main="Histogram of Hispanic American Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='red')

# Develop a dummy dataframe for Caucasian American histograms
dumCaucasian <- subset(dataSubset, RIDRETH1 == 'Non-Hispanic White')
hist_CauSyst <- hist(dumCaucasian$SystolAvg,
                     main="Histogram of Caucasian American Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='white')
hist_CauDias <- hist(dumCaucasian$DiastolAvg,
                     main="Histogram of Caucasian American Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='white')

# Develop a dummy dataframe for African American histograms
dumAfrican <- subset(dataSubset, RIDRETH1 == 'Non-Hispanic Black')
hist_AfrSyst <- hist(dumAfrican$SystolAvg,
                     main="Histogram of African American Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='black')
hist_AfrDias <- hist(dumAfrican$DiastolAvg,
                     main="Histogram of African American Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='black')

# Develop a dummy dataframe for Other American histograms
dumOther <- subset(dataSubset, RIDRETH1 == 'Other Race - Including Multi-Racial')
hist_OthSyst <- hist(dumOther$SystolAvg,
                     main="Histogram of Other Ethnic or Multi-Ethnic American Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='blue')
hist_OthDias <- hist(dumOther$DiastolAvg,
                     main="Histogram of Other Ethnic or Multi-Ethnic American Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='blue')

```

The Shapiro-Wilk Normality Test probablity values for each ethnicity's systolic and diastolic pressure distributions are given below:

For Mexican Americans:

The Systolic Pressure Probabality Value:   `r shapiro.test(dumMexican$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(dumMexican$DiastolAvg)$p.value`


For Other Hispanic Americans:

The Systolic Pressure Probabality Value:   `r shapiro.test(dumHispanic$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(dumHispanic$DiastolAvg)$p.value`


For Caucasian Americans:

The Systolic Pressure Probabality Value:   `r shapiro.test(dumCaucasian$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(dumCaucasian$DiastolAvg)$p.value`


For African Americans:

The Systolic Pressure Probabality Value:   `r shapiro.test(dumAfrican$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(dumAfrican$DiastolAvg)$p.value`


For Other Ethnic or Multi-Ethnic Americans:

The Systolic Pressure Probabality Value:   `r shapiro.test(dumOther$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(dumOther$DiastolAvg)$p.value`


Based on the shape of the histograms (which are generally more positively skewed and narrow than a normal distribution curve for the systolic and diastolic pressure distributions, respectively) and the Shapiro-Wilk Test probability values from each, only the diastolic pressures from other ethnic or multi-ethnic participants should be considered normally-distributed.

** SHOULD WE REMOVE OUTLIERS HERE? TBD ***

The Bartlett Probability Test results and a plot of the residuals error values from the average **systolic** blood pressures are presented below:

``` {r Eth_Systol_ANOVA_Assump, include=T}

bartlett.test(SystolAvg ~ RIDRETH1, data=dataSubset)

# Plot the residuals from the ANOVA object to judge the idependence of the error
aov_EthSystol = aov(SystolAvg ~ RIDRETH1, data = dataSubset)
plot(aov_EthSystol, 1)

```

From the Bartlett probability value, the variance among systolic pressure data cannot be considered equivalent between each ethnic group; however, the plot of the systolic pressure residuals shows a consistent error in the terms within the data pressure ranges.  With the Shapiro Test results from above, the systolic blood pressure data appears to only satisfy two of the three assumptions for the ANOVA test.

The Bartlett Probability Test results and a plot of the residuals error values from the average **diastolic** blood pressures are presented below:

``` {r Eth_Diastol_ANOVA_Assump, include=T}

bartlett.test(DiastolAvg ~ RIDRETH1, data=dataSubset)

# Plot the residuals from the ANOVA object to judge the idependence of the error
aov_EthDiastol = aov(DiastolAvg ~ RIDRETH1, data = dataSubset)
plot(aov_EthDiastol, 1)

```

From the Bartlett probability value, the variance among diastolic pressure data cannot be considered equivalent between each ethnic group; however, similar to the systolic data, the plot of the diastolic pressure residuals shows a consistent error in the terms within the data pressure ranges.  With the Shapiro Test results from above and similar to the systolic data, the diastolic blood pressure data appears to only satisfy two of the three assumptions for the ANOVA test.

Based on the results of the normality, Bartlett, and residuals tests, the ANOVA test results may normally be suspect; however, with a minimum sample size in the non-Mexican Hispanic ethnicity of `r nrow(dumHispanic)`, the study sample size is large enough to pull stastically-significant data.

## Do Ethnic Groups Have the Same Systolic and Diastolic Blood Pressures?

### Systolic Pressure

The results of the normality testing of the systolic blood pressure from various ethnic groups are presented with respect to each other on a single box plot below:

``` {r Eth_Systol_BoxPlots, include=T}

# Plot Systol Averages on BoxPlot to visually commpare mean and variance data with respect to Ethnic Background
ggplot(dataSubset, aes(x=RIDRETH1, y=SystolAvg)) + 
  geom_boxplot(colour=c('tan', 'red', 'grey', 'black', 'blue'), outlier.shape=8, outlier.size=4) +
  labs(title="Systolic Blood Pressure Data with respect to Ethnicity", 
       x="Ethnicity", y = "Systolic Blood Press. (mmHg)") +
  # Add scale_x funciton to change label names to shorten them
  scale_x_discrete(labels = c('Mex Amer', 'NonMex Hisp', 'Caucasian', 'Afr Amer', 'Other'))

```

The ANOVA Test will be used to identify whether all of the five ethnic groups accounted within the dataset have the same systolic blood pressures.  The null hypothesis for this test will be that the ethnic groups do *not* share the same mean blood pressure; for an ANOVA probability less than 0.05 (based on a 95% confidence interval), the mean values will not be considered equivalent between all five ethnic groups and more testing (Scheffe's Procedure, since the sample sizes between the groups are varied) will be necessary.

``` {r Eth_Systol_ANOVA, include=T}

# Dispaly the ANOVA test of the AVG Systol data against Ethnicity since we already calculated the ANOVA test results with the residuals plots
summary(aov_EthSystol)

```

Based on the results of the box plot, which shows a small but noticable difference in the mean systolic blood pressures as high as ~10 mmHg, and the ANOVA test with an ANOVA probablity value significantly less than 0.05, the systolic blood pressures between the ethnic groups are *not* equivalent.

The results of the Scheffe Multiple Comparisons test are reported below:

``` {r Eth_Systol_Schiffe, include=T}

# Run the Scheffe Test to see with Ethnicities can be considered to have the same Systolic Blood Pressures
eth_SystCompar <- scheffe.test(aov_EthSystol,"RIDRETH1", group=TRUE, console=TRUE,
   main="Systolic Blood Pressure between Different Ethnicities")

```

From the Scheffe results, Caucasian, African, and all Hispanic and other ethnicities have different systolic blood pressures.  Mexican, other Hispanic, and all other or multi-ethnic Americans from the survey are considered to have the same systolic blood pressure which is different and lower than Caucasian American systolic blood pressure which, in turn, is different and lower than African American systolic blood pressure.

### Diastolic Pressure

The results of the normality testing of the diastolic blood pressure from various ethnic groups are presented with respect to each other on a single box plot below:

``` {r Dia_Systol_BoxPlots, include=T}

# Plot Diastol Averages on BoxPlot to visually commpare mean and variance data with respect to Ethnic Background
ggplot(dataSubset, aes(x=RIDRETH1, y=DiastolAvg)) + 
  geom_boxplot(colour=c('tan', 'red', 'grey', 'black', 'blue'), outlier.shape=8, outlier.size=4) +
  labs(title="Diastolic Blood Pressure Data with respect to Ethnicity", 
       x="Ethnicity", y = "Diastolic Blood Press. (mmHg)") +
  # Add scale_x funciton to change label names to shorten them
  scale_x_discrete(labels = c('Mex Amer', 'NonMex Hisp', 'Caucasian', 'Afr Amer', 'Other'))

```

The ANOVA Test will be used to identify whether all of the five ethnic groups accounted within the dataset have the same diastolic blood pressures.  The null hypothesis for this test will be that the ethnic groups do *not* share the same mean blood pressure; for an ANOVA probability less than 0.05 (based on a 95% confidence interval), the mean values will not be considered equivalent between all five ethnic groups and more testing (Scheffe's Procedure, since the sample sizes between the groups are varied) will be necessary.

``` {r Dia_Systol_ANOVA, include=T}

# Dispaly the ANOVA test of the AVG Diastol data against Ethnicity since we already calculated the ANOVA test results with the residuals plots
summary(aov_EthDiastol)

```

Based on the results of the box plot, which shows a small but noticable difference in the mean diastolic blood pressures as high as ~5 mmHg, and the ANOVA test with an ANOVA probablity value significantly less than 0.05, the diastolic blood pressures between the ethnic groups are *not* equivalent.

The results of the Scheffe Multiple Comparisons test are reported below:

``` {r Eth_Diastol_Schiffe, include=T}

# Run the Scheffe Test to see with Ethnicities can be considered to have the same Diastolic Blood Pressures
eth_SystCompar <- scheffe.test(aov_EthDiastol,"RIDRETH1", group=TRUE, console=TRUE,
   main="Diastolic Blood Pressure between Different Ethnicities")

```

Compared to the systolic blood pressure, the Scheffe Test results report that the diastolic pressure values are much more uniform among surveyed ethnicities. Mexican Americans and Caucasian, other Hispanic, and other or multi-ethnic Americans have the statistically same average diastolic blood pressure, and African Americans and Caucasian, other Hispanic, and other or multi-ethnic Americans have the statistically same average diastolic blood pressure; in this way, only Mexican Americans and African Americans have different diastolic blood pressures.

## Conclusion of Ethnicity's Effect on Blood Pressure

Based on the results of ANOVA and Schiffe testing, there is a statistical difference between the average systolic and diastolic pressures between various ethnic groups within the United States and, thus, a link between ethnicity and blood pressure.





# The Effect of Gender on Blood Pressure (presented by Krystal Payton)

####Gender Blood Pressure

```{r Reloaded, include=F}
loadPkg('tidyverse')
loadPkg('foreign')      # Necessary to import DTA files
loadPkg('agricolae')    # Necessary for Scheffe Test

dataBP <- read.dta('SampleData_BP.dta')
dataBP
```

```{r Reload, include=F}

# First subset is to narrow rows by age and select relevant columns 
dataSub <- subset(dataBP, RIDAGEYR > 17, select = c('SEQN', 'BPQ150A', 'BPQ150B', 'BPQ150C', 'BPQ150D', 'BPXSY1', 'BPXSY2', 'BPXSY3', 'BPXSY4', 'BPXDI1', 'BPXDI2', 'BPXDI3', 'BPXDI4', 'RIAGENDR', 'RIDAGEYR'))

dataSub <- subset(dataSub, BPQ150A != 'Yes' &  BPQ150B != 'Yes' & BPQ150C != 'Yes' & BPQ150D != 'Yes')

dataSub$SystolAvg <- rowMeans(dataSub[c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')], na.rm=TRUE)
dataSub$DiastolAvg <- rowMeans(dataSub[c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')], na.rm=TRUE)

dataSub <- subset(dataSub, SystolAvg != 0 &  DiastolAvg != 0, select = c('SEQN', 'SystolAvg', 'DiastolAvg', 'RIAGENDR', 'RIDAGEYR'))
summary(dataSub)

```


In this section, we will be comparing whether the diastolic and systolic blood pressures had different affects on both males or females or whether the two genders were the same.  The gender of the participants is labeled as a quantitative, integer variable.  The participants have identified themselves as either male or female and the results on the total number of each gender are provided in the bar graph below:

## Visual Presentation of Data (Bar-graph)
```{r Barployt_Gender, include=T}
Gender_Count <- table(dataSub$RIAGENDR)
barPlot_Gender <- barplot(Gender_Count,
                             main="Gender of the Participants",
                             xlab="Gender of Participant",
                             ylab='Count of Participants',
                             names.arg= c('Male', 'Female'),
                             col= c('blue', 'orange'))


```

There is a total of `r sum(Gender_Count)` participants who have been identified as either male or female and all are above the age of 17 and contained adequeate blood pressure data for both systolic and diastolic blood pressures.  There are:
`r sum(Gender_Count["Female"])` or `r sum(Gender_Count["Female"])/sum(Gender_Count)*100`% whom were females,
`r sum(Gender_Count["Male"])` or `r sum(Gender_Count["Male"])/sum(Gender_Count)*100`% whom were males.


## Systolic and Diastolic Pressures with Respect to Each Category (Histograms, QQ-Plots and Shapiro Normality Test)

We will now check for normality within the results of the blood pressure for both math and females.  We will use the Shapiro-Wilk test, histograms, and qq-plots plots for the average systolic and diastolic blood pressures from each gender group.  We will first use the histograms which are presented below:

```{r include=T}
Female_test <- subset(dataSub, RIAGENDR == 'Female')
hist_Female_1 <- hist(Female_test$SystolAvg,
                     main="Histogram of Female Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='yellow')

Male_test <- subset(dataSub, RIAGENDR == 'Male')
hist_Male_1 <- hist(Male_test$SystolAvg,
                     main="Histogram of Male Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='red')

hist_Female_2 <- hist(Female_test$DiastolAvg,
                     main="Histogram of Female Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='yellow')
hist_Male_2 <- hist(Male_test$DiastolAvg,
                     main="Histogram of Male Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='red')

```

The histograms appear to be normally distributed for both the systolic and diastolic blood pressures for males.  The systolic blood pressure histogram for females is skewed slightly to the right but the diastolic blood pressures for females appear to be normally distributed.  We will now use the qq-plots to see if the histograms are showing a normal distribution.

```{r ggplot_gender}
#loadPkg(ggplot2)
#ggplot(data=Female_test, aes(SystolAvg)) + 
#  geom_histogram(breaks=seq(0, 300, by = 50), 
 #                col="red", 
 #                fill="#0000aa", 
  #               alpha = .7) + # opacity
 # labs(title="GRE Histogram for Females Systolic") +
  #labs(x="Average Systolic Blood Pressure", y="Count of Pressure") 

qqnorm(Female_test$SystolAvg, main="Q-Q plot of Female Systolic Blood Pressure", ylab = "Systolic Blood Pressure Quantiles") 
qqline(Female_test$SystolAvg)

qqnorm(Male_test$SystolAvg, main="Q-Q plot of Male Systolic Blood Pressure", ylab = "Systolic Blood Pressure Quantiles") 
qqline(Male_test$SystolAvg)

qqnorm(Female_test$DiastolAvg, main="Q-Q plot of Female Diastolic Blood Pressure", ylab = "Diastolic Blood Pressure Quantiles") 
qqline(Female_test$DiastolAvg)

qqnorm(Male_test$DiastolAvg, main="Q-Q plot of Male Diastolic Blood Pressure", ylab = "Diastolic Blood Pressure Quantiles") 
qqline(Male_test$DiastolAvg)
```

From the qq-plots we can see the following:

1. Female Systolic - The quantiles are not completely normally distributed.  The blood pressures under 100 and over about 135 quantiles are all above the normality line especially at the end.
2. Male Systolic - The quantiles are normally distributed until about 140 and are all above the distribution line
3. Female Diastolic - Similar to the systolic, the two ends of the distribution are off of the distribution line but this appears to be closer to normal with a fewer variance at the ends.
4. Male Diastolic - The qq-plot appears to be normally distributed like that of the female diastolic qq-plot with the ends being off slightly off of the distribution line.

From the qq-plots, the diastolic blood pressures for both male and females are closer to noramlity.  The systolic blood pressures for males are closer to normality than that of females in these plots.  We will now use the Shapior-Wilk Normality Test to get more in-depth about the normality in the blood pressures with gender.

The Shapiro-Wilk Normality Test probablity values for each genders systolic and diastolic pressure distributions are given below:

For Females:

The Systolic Pressure Probabality Value:   `r shapiro.test(Female_test$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(Female_test$DiastolAvg)$p.value`


For Males:

The Systolic Pressure Probabality Value:   `r shapiro.test(Male_test$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(Male_test$DiastolAvg)$p.value`


```{r data, results=T}
#Female_test
#Male_test

shapiro.test(Female_test$SystolAvg)$p.value
shapiro.test(Female_test$DiastolAvg)$p.value
shapiro.test(Male_test$SystolAvg)$p.value
shapiro.test(Male_test$DiastolAvg)$p.value


```

## Do the Categories have equivalent Blood Pressures (T-Tests and Chi-Squared Tests for Binary Categories)

In the Shapiro-Wilk Test, the probability values from each gender show that the blood pressures for both males and females should be considered normally-distributed.  They all have small p-values showing that this is a good data sample and that this is a good indication that the test results are not due to chance.  

The null hypothesis is that the two samples carry the same average.
Let us now try to use the two-sample t-test:


```{r TTest, include=T}

ttest_Syst = t.test(Female_test$SystolAvg, Female_test$DiastolAvg)
ttest_Syst

ttest_Dias = t.test(Male_test$SystolAvg, Male_test$DiastolAvg)
ttest_Dias

```

The systolic and diastolic averages for females are `r format(ttest_Syst$estimate)` respectively. The two-sample t-test shows a small p-value of `r format(ttest_Syst$p.value)`, thereby rejected the null and the data is stastically signficant of the two groups at $\alpha$ = 0.05 (or even 0.005).

The systolic and diastolic averages for males are `r format(ttest_Dias$estimate)` respectively. The two-sample t-test shows a small p-value of `r format(ttest_Dias$p.value)`, thereby rejected the nullthe data is stastically signficant of the two groups at $\alpha$ = 0.05 (or even 0.005).

The null hypothesis is that the two samples carry the same average.


Let us now use the Chi-Square Test:
```{r contingency, include=F}
contable_1 = table(Female_test$SystolAvg, Female_test$DiastolAvg)
contable_1 # the contingency table
#loadPkg("printr")

contable_2 = table(Male_test$SystolAvg, Male_test$DiastolAvg)
contable_2
```

```{r contingency, include=F}
contable_1 = table(Female_test$SystolAvg, Female_test$DiastolAvg)
contable_1 # the contingency table
#loadPkg("printr")

contable_2 = table(Male_test$SystolAvg, Male_test$DiastolAvg)
contable_2
```

```{r chisq}
chitest = chisq.test(contable_1)
chitest

chitest_1 = chisq.test(contable_2)
chitest_1

chitest$p.value
chitest_1$p.value
```

A $\chi^2$-test for the female's blood pressure confirms the p-value to be `r format(chitest$p.value)` and for the male's blood pressure `r format(chitest_1$p.value)`.  We can adopt that the two frequency distributions are the same.  This is equivalent to saying that systolic and diastolic blood pressures are independent of each other. There is no effect on whether someone is male and females from the different blood pressures.

So we reject the null, and the systolic and diastolic blood pressures are independent of each other.

Therefore, diastolic and systolic blood pressures are not dependent on one another and it does not matter whether you really are male or female to have higher blood pressures.

####Veterans Blood Pressure



```{r loadeddata, include=F}
dataML <- read.csv('DMQMILIT_l.csv')
dataML

```

```{r datasubset_vets, include=T}
dataSubset_1 <- subset(dataML, DMQMILIT_l == "No" | DMQMILIT_l == "Yes" | DMQMILIT_l =="Refused", select = c('SEQN', 'BPQ150A', 'BPQ150B', 'BPQ150C', 'BPQ150D', 'BPXSY1', 'BPXSY2', 'BPXSY3', 'BPXDI1', 'BPXDI2', 'BPXDI3', 'DMQMILIT_l'))

dataSubset_1 <- subset(dataSubset_1, BPQ150A != 'Yes' &  BPQ150B != 'Yes' & BPQ150C != 'Yes' & BPQ150D != 'Yes')

dataSubset_1$SystolAvg <- rowMeans(dataSubset_1[c('BPXSY1','BPXSY2','BPXSY3')], na.rm=TRUE)
dataSubset_1$DiastolAvg <- rowMeans(dataSubset_1[c('BPXDI1','BPXDI2','BPXDI3')], na.rm=TRUE)

dataSubset_1 <- subset(dataSubset_1, SystolAvg != 0 &  DiastolAvg != 0, select = c('SEQN', 'SystolAvg', 'DiastolAvg', 'DMQMILIT_l'))
summary(dataSubset_1)
```
## Visual Presentation of Data (Bar-graph)

In this section, we will be comparing whether the diastolic and systolic blood pressures had different affects on participants with different veteran statuses.  The veteran status of the participants is labeled as a quantitative, integer variable.  The participants have identified themselves as either veteran or non-veteran or refused to answer.  The results on the total number of each are provided in the bar graph below:

```{r Barployt_Veterans, include=T}
Veterans_Count <- table(dataSubset_1$DMQMILIT_l)
barPlot_Veterans <- barplot(Veterans_Count,
                             main="Veterans Status of the Participants",
                             xlab="Veterans Status",
                             ylab='Count of Participants',
                             names.arg= c('No', 'Refused','Yes'),
                             col= c('orange', 'white', 'blue'))


```
There are a total of `r sum(Veterans_Count)` participants who are above the age of 17 with an adequate amount of information for diastolic and systolic blood pressures.  Of those particpants, there are:
`r sum(Veterans_Count["Yes"])` or `r sum(Veterans_Count["Yes"])/sum(Veterans_Count)*100`% whom were Veterans,
`r sum(Veterans_Count["No"])` or `r sum(Veterans_Count["No"])/sum(Veterans_Count)*100`% whom were non-Veterans, and
`r sum(Veterans_Count["Refused"])` or `r sum(Veterans_Count["Refused"])/sum(Veterans_Count)*100`% whom refused to respond.


## Systolic and Diastolic Pressures with Respect to Each Category (Histograms, QQ-Plots and Shapiro Normality Test)

We can check for normality within the results of the blood pressure for the veteran status.  We will use the Shapiro-Wilk test, histograms, and qq-plots plots for the average systolic and diastolic blood pressures the two veteran status.  We will first use the histograms which are presented below:


```{r hist_vets, include=T}
# Develop a dummy dataframe for Mexican American histograms
Veterans_test <- subset(dataSubset_1, DMQMILIT_l == 'Yes')
hist_Veterans_1 <- hist(Veterans_test$SystolAvg,
                     main="Histogram of the Veterans Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='purple')

Non_Veterans_test <- subset(dataSubset_1, DMQMILIT_l == 'No'| DMQMILIT_l == 'Refused')
hist_Non_Vet_1 <- hist(Non_Veterans_test$SystolAvg,
                     main="Histogram of the Non Veterans Systolic BP",
                     xlab="Average Systolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='yellow')

hist_Veterans <- hist(Veterans_test$DiastolAvg,
                     main="Histogram of the Veterans Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='purple')
hist_Non_Vet_2 <- hist(Non_Veterans_test$DiastolAvg,
                     main="Histogram of the Non Veterans Diastolic BP",
                     xlab="Average Diastolic Blood Pressure",
                     ylab='Count of Pressures',
                     col='yellow')


```
Note: The one person whom refused to answer whether they were a veteran or not is included in the non veteran data going forward.

From the 4 histograms, the only one that seems skewed to the right is the histogram for the non veterans systolic blood pressure.  The histograms for 3 remaining graphs are appearing to be normally distributed.  To back this finding up, we will now us the QQ-Plots to check for normality.



```{r include=T}
qqnorm(Veterans_test$SystolAvg, main="Q-Q plot of Veterans Systolic Blood Pressure", ylab = "Systolic Blood Pressure Quantiles") 
qqline(Veterans_test$SystolAvg)

qqnorm(Non_Veterans_test$SystolAvg, main="Q-Q plot of Non Veterans Systolic Blood Pressure", ylab = "Systolic Blood Pressure Quantiles") 
qqline(Non_Veterans_test$SystolAvg)

qqnorm(Veterans_test$DiastolAvg, main="Q-Q plot of Veterans Diastolic Blood Pressure", ylab = "Diastolic Blood Pressure Quantiles") 
qqline(Veterans_test$DiastolAvg)

qqnorm(Non_Veterans_test$DiastolAvg, main="Q-Q plot of Non Veterans Diastolic Blood Pressure", ylab = "Diastolic Blood Pressure Quantiles") 
qqline(Non_Veterans_test$DiastolAvg)

```
The QQ-Plots for the Veterans and Non-Veterans are as follows:

1. Veteran Systolic Blood Pressure - There appears that there is a normal distribution but it fades off at the end of the data points.
2. Non Veterans Systolic Blood Pressure - This is the less normally distributed graph out of all 4 graphs.  The end of the distribution is far above the distribution line compared to the rest of the data.
3. Veterans Diastolic Blood Pressure - This graph is the most normally distributed graph out of all the 4 graphs.
4. Non Veterans Diastolic Blood Pressure - This is a fairly normally distributed graph but the ends go off from the distribution line.

The QQ-plots are showing more normally distributed in all but the non veterans systolic blood pressure.  This goes along with the histogram graphs above where the histogram for the non veterans systolic is skewed more to the right.  We will now use the Shapiro-Wilk Normality Test to see if these results are accurate.


The Shapiro-Wilk Normality Test probablity values for each genders systolic and diastolic pressure distributions are given below:

For Veterans:

The Systolic Pressure Probabality Value:   `r shapiro.test(Veterans_test$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(Veterans_test$DiastolAvg)$p.value`


For Non Veterans:

The Systolic Pressure Probabality Value:   `r shapiro.test(Non_Veterans_test$SystolAvg)$p.value`

The Diastolic Pressure Probabality Value:   `r shapiro.test(Non_Veterans_test$DiastolAvg)$p.value`


In the Shapiro-Wilk Test, the probability values from each gender show that the blood pressures for both males and females should be considered normally-distributed.  They all have small p-values showing that this is a good data sample and that this is a good indication that the test results are not due to chance.  

The null hypothesis is that the two samples carry the same average.

## Do the Categories have equivalent Blood Pressures (T-Tests for Binary Categories)
We will now try the two-sample t-test:

```{r data_Vets, include=F}
Veterans_test
Non_Veterans_test
```

```{r TTest_Vets, include=T}
ttest_Vet = t.test(Veterans_test$SystolAvg, Veterans_test$DiastolAvg)
ttest_Vet

ttest_NonVet = t.test(Non_Veterans_test$SystolAvg, Non_Veterans_test$DiastolAvg)
ttest_NonVet
```


The systolic average for veterans are `r format(ttest_Vet$estimate)` respectively. The two-sample t-test shows a small p-value of `r format(ttest_Vet_Syst$p.value)`, thereby rejected the null with the means at $\alpha$ = 0.05 (or even 0.005).

The diastolic average for non veterans are `r format(ttest_NonVet$estimate)` respectively. The two-sample t-test shows a small p-value of `r format(ttest_Vet_Dias$p.value)`, thereby rejected the null with the means at $\alpha$ = 0.05 (or even 0.005).

The null hypothesis is that the two samples carry the same average.  The systolic and diastolic blood pressures are independent of each other.

# The Effect of Age on Blood Pressure (presented by Siwei Yang)

**Select the subsets with `Age` between 18 and 30, 30 and 50, elder than 50 separately.

``` {r}
loadPkg("ggplot2")
loadPkg("faraway")
loadPkg("modelr")
Sub18_30 <- dataSubset[(dataSubset$RIDAGEYR>=18)&(dataSubset$RIDAGEYR<30),]
Sub30_50 <- dataSubset[(dataSubset$RIDAGEYR>=30)&(dataSubset$RIDAGEYR<50),]
Sub50 <- dataSubset[dataSubset$RIDAGEYR>=50,]
testdf18_30 = Sub18_30[,c("SystolAvg","DiastolAvg","RIDAGEYR")]
testdf30_50 = Sub30_50[,c("SystolAvg","DiastolAvg","RIDAGEYR")]
testdf50 = Sub50[,c("SystolAvg","DiastolAvg","RIDAGEYR")]
```                                                                                      
```Making varibales numerical before doing the correlation test.```
## Visual Presentation of Data (Bar-graph)

**Show correlation among different pairs of variables.**  

```{r}
loadPkg("corrplot")
testdf18_30cor = cor(testdf18_30) 
#testdf18_30
corrplot(testdf18_30cor) 
# corrplot (matrix)
```
```From the corrplot above, we can easily see that the relationship between blood pressure and people aged 18 to 30 are not significant. ```
```{r}
testdf30_50cor = cor(testdf30_50) 
#testdf18_30
corrplot(testdf18_30cor) 
```
```This corrplot also demonstrates that middle aged people (30-50) do not have that higher blood pressure.```
  
```{r}
testdf50cor = cor(testdf50) 
#testdf50
corrplot(testdf50cor)
```                                                                                       
```Older people (above 50) seem to have higher blood pressure than yonger generations. That's what we expected before. ```
**Build linear models with independent variables to predict.**  

```{r age model1}
fit1 <- lm(SystolAvg ~ ageGroup, data =dataSubset)
summary(fit1)
# vif(fit1)
```
SystolAvg = 133.572 - 0       if elder
SystolAvg = 133.572 - 15.058  if middle
SystolAvg = 133.572 - 20.405  if young

```We divide the blood pressure into two groups as before, which are systolic average blood pressure and diastolic blood pressure. In this chunk, we mainly discuss age groups whether have an effect on systolic blood pressure. The model is simple as we can see because we only have one varibale inside. The middle-aged people will have 15.058 smaller systolic average blood pressure than the old. Yonger people, in the meantime expected to have 20.405 smaller systolic average blood pressure. I also make some plots that can easily explain the relationship between two varibales.```
```{r age model2}
fit2 <- lm(DiastolAvg ~ ageGroup, data =dataSubset)
summary(fit2)
# vif(fit1)
```
```For this chunk, we want to know the relationship between age group and diastolic average blood pressure. Holding all others equal, for middle group people each year increases in age predicting 2.302 increase in DiastolAve blood pressure. Also, for young people holding all others equal, each year increases in age predicting 6.366 decrease in diastolic blood pressure. The p value is <2e-16, which means that the model is significant. But R square and adjusted R square is not big, age group can only expalin 6.9% of diastolic blood pressure. Therefore, the model is not that accurate.```
```{r age model1b}
# plot( SystolAvg ~ ageGroup, data = dataSubset)
# boxplot(SystolAvg~ageGroup,data=dataSubset,main="Sys", xlab="AgeGroup", ylab="GRE")
loadPkg("ggplot2")
ggplot(dataSubset, aes(x=ageGroup, y=SystolAvg)) + 
  geom_boxplot( colour=c("#ff0000","#11cc11","#0000ff"), outlier.shape=8, outlier.size=4) + labs(title="systolic blood pressure", x="ageGroup", y = "SystolAvg")
ggplot(dataSubset, aes(x=ageGroup, y=DiastolAvg)) + 
  geom_boxplot( colour=c('black','yellow','blue'), outlier.shape=8, outlier.size=4) + labs(title="diastol blood pressure", x="ageGroup", y = "DiastolAve")
# plot(fit1)
```
```Here, we also use two blood pressure groups. For systolic average blood pressure, older people are observed to have higher blood pressure than the other two groups. Middle aged people have a little bit higher blood pressure than the young. For diastolic blood pressure, 30-50 aged people seem to have higher blood presurre than people more than 50. Younger people are still with lowest blood pressure. ```
```{r}
loadPkg("ggplot2")
ggplot(data=dataSubset, aes(x=RIDAGEYR, y=SystolAvg, color=ageGroup )) + 
  geom_point( outlier.shape=8, outlier.size=4 ) +
  labs(title="ggplot", x="age", y = "systolic blood pressure")
ggplot(data=dataSubset, aes(x=RIDAGEYR, y=DiastolAvg, color=ageGroup )) + 
  geom_point( outlier.shape=8, outlier.size=4 ) +
  labs(title="ggplot", x="age", y = "diastolic blood pressure")
```
```The results are shown the same as we mentioned before. The points are much easier to see the elder peole will have higher systolic average blood pressure than the other two groups. The middle aged people actually have less difference with younger people. The diastolic blood pressure, there is actually not that much difference bewteen different aged people.```

## Visual Presentation of Data (Bar-graph)

## Systolic and Diastolic Pressures with Respect to Each Category (Histograms and Shapiro Normality Test)

## Do the Categories have equivalent Blood Pressures (Box Plots and ANOVA Test for multiple Categories or Linear regression if no categorizing ages together)

# The Effect of Annual Household Income on Blood Pressure (presented by Juhne Zhang)

My expectation is that people with higher annual household income would have healthier blood pressure status. The reason I make this expectation is because eatting healthy is more expensive. Usually people would spend similar amount of money from their annual household income for food, which means people with higher household income would be more likely to consider eatting healthy food because they can afford it. Therefore, they would have higher chance of getting healthier blood pressure status.

## Visual Presentation of Data (Bar-graph)

The dataframe I use has seven variables, I am interested in the relationship between American family annual household income and their blood pressures. There are two different type of blood pressures, Diastolic blood pressures and Systolic blood pressures. They are the two indicaters to measure your blood pressure. The below table shows top five row in the dataframe.

```{r HHI read data}
#read
df_HHI <- data.frame(dataSubset)
#display top 5
head(df_HHI,5)
dim(df_HHI)
```

To be more confident about our data, the next thing I did is identify and removing the outliers. This can increase the accuracy of the plots we are going to draw. In other word, to make our final results more reliable. The graphs below show that their are too many outliers and have a serious bad influence on the dataset. After removing the outliers, the graphs above tend to be better scaled with normal distribution. 

```{r HHI clean data}
#remove outlier

df_HHI = outlierKD2(df_HHI, SystolAvg, TRUE)
df_HHI = outlierKD2(df_HHI, DiastolAvg, TRUE)

dim(df_HHI)
```

#test normality

In order to apply annova test to our 12 annual household income, I need to check their normality. All the data points on the graph are in the middle of the graph and formed a 45 degree straight line, this indicates both Systolic and Diastolic blood pressure data are normally distributed.

```{r HHI normality test}

qqnorm(df_HHI$SystolAvg)

qqnorm(df_HHI$DiastolAvg)

```

Then, I want to know the numebr of patients in each categories and decide if make sample on categories. I build a frequency table for each category and notice that category $7,5000 and above and too many data points. It might because that patients did not want to reveal their actual annual household income. All the other categories seem to have good frequency, which followed a normal distribution.
```{r HHI HHI-Bar}
#read household dataset
#df_HHI <- read.csv('./datasets/dataset_INDHHINC_l/INDHHINC_l.csv')
#df_HHI <- data.frame(dataSubset)
#display top 5
#head(df_HHI,5)
#remove Don't know ...
#dim(df_HHI)[1]
df_HHI <- subset(df_HHI, ! INDHHINC %in% c('Don\'t know', 'Over $20,000', 'Refused', 'Under $20,000'))
#df_HHI[df_HHI[,'INDHHINC'] == 'Over $20,000',]
#dim(df_HHI)[1]
#remove na
#dim(df_HHI)[1]
df_HHI <- df_HHI[complete.cases(df_HHI),]
#head(df_HHI[rowSums(is.na(df_HHI))>0,])
#dim(df_HHI)[1]
#get number of diff categorical value under household
df_HHI$INDHHINC <- factor(df_HHI$INDHHINC)
HH_cats <- levels(df_HHI$INDHHINC)
#HH_cats
#get frequency
HH_freq <- table(df_HHI$INDHHINC)
df_HH_freq <- as.data.frame(HH_freq)
df_HH_freq
#rename frequency df columns
colnames(df_HH_freq) <- c('HH_income','Freq')
#
#names(df_HH_freq)
ggplot(data=df_HH_freq, aes(x=HH_income, y=Freq, color=HH_income)) +
  geom_bar(stat='identity', width=0.5, fill = 'white') +
    theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
    ggtitle('Freq vs \nAnnual Household Income')
```

## Systolic and Diastolic Pressures with Respect to Each Category (Histograms and Shapiro Normality Test)

###get mean of Systolic and Diastolic blood pressure average

In order to show the relationship between each category and blood pressure, I need to build a table with each category's mean blood pressure.

```{r HHI HH_mean_avg_sys_dia}
mean_avg_sys_dia <- df_HHI %>%
              group_by(INDHHINC) %>%
              summarise(SystolAvg = mean(SystolAvg),
                        DiastolAvg = mean(DiastolAvg)
                        )
mean_avg_sys_dia
```

###convert numerical HH_income

I also need to convert the factor into corresponding numerical value so that cor.test function can be applied.

```{r HHI create numer_HHI}
numer.INDHHINC <- as.numeric(mean_avg_sys_dia$INDHHINC)
mean_avg_sys_dia$DiastolAvg
numer.INDHHINC
```

###display correlation between mean average blood presure according to annual household income

The scatter plot shows that most Systolic blood pressure data points have their mean on the center and less data points distributed on both sides under each category. This tells that the blood pressure data points under each category is normally distributed.

Since the annual household income is ordinal, I find that Systolic blood pressure have a negative correlation with annual household income. The accual correlation between them is `r cor(numer.INDHHINC, mean_avg_sys_dia$SystolAvg, method = 'pearson')`, which support this idea. This test shows that the population with higher annual household income will have relatively lower Systolic blood pressure, and vice versa.

According to American national health organization, having Systolic blood pressure above 120 is a signal for high blood pressure. This negative correlation shows that people with lower annual household income are more likely to have high blood pressure. On the other hand, most people with Systolic blood pressure higher than 120 are from the first half part of the annual household income which is below $3,5000.

```{r HHI HH_systolic}

#annual household systolic scatter plot
ggplot(df_HHI, aes(x=INDHHINC, y=SystolAvg, color=INDHHINC)) +
  geom_point(alpha = .05) + 
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle('Systolic BP Avg vs Annual Household Income') +
  ylab('Systolic BP Avg') +
  xlab('Annual Household Income')
#plot systolic mean for each category
ggplot(mean_avg_sys_dia, aes(x=INDHHINC, y=SystolAvg, color=INDHHINC)) +
  geom_point(size = 4) + 
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle('Mean of Systolic BP Avg vs Annual Household Income') +
  ylab('Mean of Systolic BP Avg') +
  xlab('Annual Household Income')
#get corelation
cor(numer.INDHHINC, mean_avg_sys_dia$SystolAvg, method = 'pearson')

#mean vector for each cat
avg_sys <- c()
#calculate mean for Sys
for(cat in HH_cats){
  #append mean for each cat
  avg_sys <- c(avg_sys, mean(df_HHI[df_HHI$INDHHINC == cat,2], na.rm=TRUE))
}
      
```

The scatter plot shows that most Diastolic blood pressure data points have their mean on the center and less data points distributed on both sides under each category. This tells that the Diastolic blood pressure data points under each category is normally distributed.

On the other hand, the Diastolic blood pressure correlation test shows a positive relation with the annual household income. The correlation is `r cor(numer.INDHHINC, mean_avg_sys_dia$DiastolAvg, method = 'pearson')`, which is a very significant positive correlation. In other word, the higher the annual house hold income the higher their Diastolic blood pressure. 

Although, the graph shows a positive correlation between Diastolic blood pressure and annual household income, the average Diastolic blood pressure for the second half of the group which is annual household income above $3,5000 are still lower than 80, which is within the healthy Diastolic blood pressure range release by the American national health organization.

```{r HHI HH_Diastolic}
#annual household Diastolic scatter plot
ggplot(df_HHI, aes(x=INDHHINC, y=DiastolAvg, color=INDHHINC)) +
  geom_point(alpha = 0.1) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle('Diastolic BP Avg vs Annual Household Income') +
  ylab('Diastolic BP Avg') + 
  xlab('Annual Household Income')

#plot Diastolic mean for each category
ggplot(mean_avg_sys_dia, aes(x=INDHHINC, y=DiastolAvg, color=INDHHINC)) +
  geom_point(size = 4) + 
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle('Mean of Diastolic BP Avg vs Annual Household Income') +
  ylab('Mean of Diastolic BP Avg') +
  xlab('Annual Household Income') 
  
#get corelation
cor(numer.INDHHINC, mean_avg_sys_dia$DiastolAvg, method = 'pearson')
```

## Do the Categories have equivalent Blood Pressures (Box Plots and T-Tests for Binary Categories and ANOVA Test for multiple Categories)

The Systolic BP Avg vs Annual Household Income boxplot shows that the mean Systolic blood pressure for each category does not vary too much from each other, this makes common sense since human blood pressure is within this range.

```{r HHI Box plots Systolic}
#boxplot for systolic avg vs household
ggplot(df_HHI, aes(x=INDHHINC, y=SystolAvg, color=INDHHINC)) +
  geom_boxplot(alpha = 0.1) + 
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle('Systolic BP Avg vs Annual Household Income') +
  ylab('Systolic BP Avg') +
  xlab('Annual Household Income')
```

##anova test for systolic blood pressure vs annual household income

The anova test and tukey test for Systolic blood pressure shows that high annual household income categories have different Systolic blood pressure means with low annual household income. This result shows that annual household income do have effect on Systolic blood pressure.

```{r HHI aov Systolic}

sys_aov = aov(SystolAvg ~ INDHHINC, data = df_HHI)
summary.aov(sys_aov)
tukey_sys_AoV <- TukeyHSD(sys_aov)
#tukey_sys_AoV
tukey_sys_AoV$INDHHINC[tukey_sys_AoV$INDHHINC[,4]<0.05,4]

```

The Diastolic BP Avg vs Annual Household Income boxplot shows that the mean Systolic blood pressure for each category does not vary too much from each other, this makes common sense since human blood pressure is within this range. 

```{r HHI Box plots diastolic}
#
ggplot(df_HHI, aes(x=INDHHINC, y=DiastolAvg, color=INDHHINC)) +
  geom_boxplot(alpha = 0.1) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
  ggtitle('Diastolic BP Avg vs Annual Household Income') +
  ylab('Diastolic BP Avg') + 
  xlab('Annual Household Income')
```

The anova test and tukey test for Diastolic blood pressure shows that high annual household income categories have different Diastolic blood pressure means with low annual household income. This result shows that annual household income do have effect on Diastolic blood pressure.

```{r HHI aov Diastolic}

dia_aov = aov(DiastolAvg ~ INDHHINC, data = df_HHI)
summary.aov(dia_aov)
tukey_dia_AoV <- TukeyHSD(dia_aov)
tukey_dia_AoV$INDHHINC[tukey_dia_AoV$INDHHINC[,4]<0.05,4]
```

#Healthy blood pressure frequency plot for each category

Finally, I need to conform my expectation that people with higher annual household income would have healthier blood pressure status. The healthy blood pressure indicators that release by American national health organization is Systolic blood pressure below 120 and Diastolic blood pressure below 80.

To get the healthy blood pressure proportion for each category, I need to first filter out the patients with Systolic blood pressure under 120 and Diastolic blood pressure under 80 and then build a frequency table with it.  Finally, use the healthy frequency table divide by total frequency table to get the healthy proportion table.

From the bar chart for healthy proportion table below, it shows that in average the higher annual household income the higher percentage of healthy blood pressure in that group. This support my expectation which is that people with higher annual household income would have healthier blood pressure status in average.

```{r HHI healthy blood pressure}

df_HHI_healthy <- df_HHI[df_HHI$DiastolAvg<=80  & df_HHI$SystolAvg <= 120,]
dim(df_HHI_healthy)

HH_healthy_freq <- table(df_HHI_healthy$INDHHINC)

df_HHI_healthy <- as.data.frame(HH_healthy_freq)
#rename frequency df columns
colnames(df_HHI_healthy) <- c('HH_income','healthy_Freq')
head(df_HHI_healthy)
head(df_HH_freq)
df_healthy_total <- merge(df_HH_freq, df_HHI_healthy, by='HH_income')
#head(df_healthy_total)
df_healthy_total <- df_healthy_total %>% as_tibble() %>% mutate(
  proportion = healthy_Freq / Freq
)
head(df_healthy_total)
df_order_healthy_total <- df_healthy_total[order(df_healthy_total$proportion),]
head(df_order_healthy_total)
#names(HH_healthy_freq)
ggplot(data=df_healthy_total, aes(x=HH_income, y=proportion, color=HH_income)) +
  geom_bar(stat='identity', width=0.5, fill = 'white') +
    theme(text = element_text(size=10),
        axis.text.x = element_text(angle=90, hjust=1)) +
    ggtitle('Healthy BP Freq vs \nAnnual Household Income')
```

#linear regression model test

##Sytolic blood pressure vs annual household income and Diastolic blood pressure


```{r HHI systolic lm}
loadPkg("modelr")
model.HHI <- lm(SystolAvg ~ INDHHINC+DiastolAvg, data = df_HHI)
summary(model.HHI)
coef(model.HHI)
confint(model.HHI)

model.HHI.pred <- add_predictions(df_HHI,model.HHI)
head(model.HHI.pred)

ggplot(model.HHI.pred,aes(SystolAvg,pred))+geom_point(aes(SystolAvg,pred))+geom_line(aes(pred), colour="red", size=1)
```

```{r HHI diastolic lm}
loadPkg("modelr")
model.HHI <- lm(DiastolAvg ~ INDHHINC+SystolAvg, data = df_HHI)
summary(model.HHI)
coef(model.HHI)
confint(model.HHI)

model.HHI.pred <- add_predictions(df_HHI,model.HHI)
head(model.HHI.pred)

ggplot(model.HHI.pred,aes(DiastolAvg,pred))+geom_point(aes(DiastolAvg,pred))+geom_line(aes(pred), colour="red", size=1)
```

# (OPTIONAL) Are the Variables Independent of Each other? (Chi^2 Test)



















